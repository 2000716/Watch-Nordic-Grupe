<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Filmvisning</title>

   <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/fd2fb2_39376e4ee55b460ab7a3ebbfcf35fef7~mv2.png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
* { margin: 0; padding: 0; box-sizing: border-box; }
* { margin: 0; padding: 0; box-sizing: border-box; }
* { margin: 0; padding: 0; box-sizing: border-box; }
* { margin: 0; padding: 0; box-sizing: border-box; }
/* Grunnoppsett */
body { background: #000; font-family: Arial, sans-serif; overflow: hidden; }

.container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

video {
  position: absolute;
  inset: 0;            /* dekker hele containeren */
  width: 100%;
  height: 100%;
  object-fit: contain; /* skalerer uten √• klippe */
  background: black;
  z-index: 1;
}




/* Br√∏dtekst-font */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400&display=swap');

video::cue {
  font-family: 'Inter', sans-serif;
  font-size: 26px !important;
  font-weight: 300;
  color: #ffffff;
  background: none !important;

  /* Tynn outline */
  text-shadow:
     -1px -1px 0 #000,
      1px -1px 0 #000,
     -1px  1px 0 #000,
      1px  1px 0 #000;

  /* üî• disse to gj√∏r teksten IKKE klumpete */
  letter-spacing: 0.5px;   /* mer luft mellom bokstavene */
  line-height: 1.45;       /* mer luft mellom linjene */

  white-space: pre-wrap;
  bottom: 8%;
}




/* UI container */
.ui {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  opacity: 1;
  transition: opacity 0.5s ease;
  z-index: 10;
}

.ui.hidden { opacity: 0; pointer-events: none; }

.ui:not(.hidden) .top-bar,
.ui:not(.hidden) .controls,
.ui:not(.hidden) .progress-container,
.ui:not(.hidden) .caption-menu {
  pointer-events: auto;
}

/* √òverste bar med fade */
.top-bar {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  padding: 10px 20px;
  background: linear-gradient(to bottom, rgb(0, 0, 0), rgba(0, 0, 0, 0));
  display: flex;
  align-items: center;
}

/* Tilbakeknapp */
.back-button { background: none; border: none; cursor: pointer; }
.back-button img { width: 50px; height: 50px; }

/* Kontroller nederst */
.controls {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: space-between; /* venstre - midten - h√∏yre */
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0) 90%);
}

.left-controls,
.right-controls {
  display: flex;
  gap: 25px; /* √òkt mellomrom mellom lyd, undertekst og fullskjerm */
  align-items: center;
}

.center-controls {
  position: absolute;
  left: 50%;
  transform: translateX(-50%); /* s√∏rger for at play/pause er helt i midten av skjermen */
  display: flex;
  align-items: center;
  gap: 30px; /* mellomrom mellom rewind - play - forward */
}

.btn { background: none; border: none; cursor: pointer; }
.btn img { width: 32px; }

/* Progress bar */
.progress-container {
  position: absolute;
  bottom: 75px;
  left: 0;
  width: 100%;
  display: flex;
  padding: 0 20px;
  z-index: 12;
}

.progress {
  flex: 1;
  height: 6px;
  background: #333;
  border-radius: 5px;
  position: relative;
  cursor: pointer;
}

.progress:hover { height: 10px; }

.progress-filled {
  width: 0%;
  height: 100%;
  background: #0fddcb;
  border-radius: 5px;
}

.thumb {
  position: absolute;
  top: 50%;
  width: 12px;
  height: 12px;
  background: #fff;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  cursor: pointer;
  z-index: 13;
}

.time-display {
  position: absolute;
  bottom: 87px;
  right: 20px;
  color: #fff;
  font-size: 14px;
  z-index: 12;
}

/* Undertekst- og lydmeny */
.caption-menu {
  position: absolute;
  bottom: 120px;
  right: 20px; /* flyttet til h√∏yre */
  background: rgba(9, 27, 30, 0.95);
  border-radius: 10px;
  padding: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
  display: none;
  min-width: 180px;
  z-index: 10000;
}


.caption-menu strong {
  display: block;
  margin: 8px 0 5px;
  font-size: 14px;
  font-weight: bold;
  color: #fff;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding-bottom: 4px;
}

.caption-menu button {
  display: block;
  width: 100%;
  padding: 8px 12px;
  margin: 2px 0;
  background-color: transparent;
  color: #ddd;
  border: none;
  text-align: left;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.caption-menu button:hover,
.caption-menu button.active {
  background-color: #0fddcb;
  color: #000;
  font-weight: bold;
}

.watermark {
  position: absolute;  /* f√∏lger container, ikke skjermen */
  top: 20px;
  right: 20px;
  width: 60px;
  z-index: 1000000; /* over video og UI */
  pointer-events: none; /* gj√∏r at den ikke blokkerer klikk */
}

/* Filmtittel */
.movie-title {
  color: white;
  font-size: 22px;
  font-weight: 400;   /* ‚Üê tynnere enn bold */
  margin-left: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
}



/* Loading spinner */
.loading-spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 60px;
  height: 60px;
  margin: -30px 0 0 -30px;
  border: 6px solid #333;
  border-top: 6px solid #00FFCC;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  z-index: 10000;
  display: none;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Preview-boks */
.preview-box {
  position: absolute;
  bottom: 120px;
  width: 240px;
  height: 135px;
  background: #000;
  border: 2px solid #0fddcb;
  border-radius: 10px;
  overflow: hidden;
  display: none;
  z-index: 20;
  pointer-events: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.6);
  text-align: center;
}

.preview-box img { width: 100%; height: auto; display: block; }

.preview-time {
  color: #fff;
  font-size: 14px;
  font-weight: bold;
  padding: 4px 0;
  background: rgba(0,0,0,0.6);
  position: absolute;
  bottom: 0;
  width: 100%;
}

/* Resume overlay */
.resume-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999999;
}

.resume-box {
  background: none;
  padding: 30px;
  border-radius: 12px;
  text-align: center;
  color: white;
}

.resume-box p { font-size: 18px; margin-bottom: 20px; }

.resume-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
}

.resume-buttons button {
  padding: 10px 20px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}

/* Mini-player modus */
.miniplayer {
  position: fixed !important;
  width: 320px !important;
  height: 180px !important;
  bottom: 20px;
  right: 20px;
  z-index: 99999 !important;
  cursor: move;
  border: 2px solid #0fddcb;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.7);
  background: black;
}

#continueBtn { background: #0fddcb; color: #000; }
#continueBtn:hover { background: #0bbba5; }

#restartBtn { background: #444; color: #fff; }
#restartBtn:hover { background: #666; }

.like-btn {
  background: none;
  border: none;
  color: #fff;
  font-size: 18px;       /* Litt st√∏rre tekst */
  font-weight: bold;     /* Fet skrift */
  cursor: pointer;
  padding: 10px 20px;
  border-radius: 50px;   /* Gj√∏r knappen "pill-formet" */
  transition: all 0.3s ease;
}

.like-btn:hover {
  background: rgba(255, 255, 255, 0.15); /* Lys rund bakgrunn */
  color: #0fddcb;  /* Endre tekstfargen ved hover */
}

.subtitle-overlay {
  position: absolute;
  bottom: 5%;
  width: 100%;
  text-align: center;
  pointer-events: none;
  z-index: 5;
  font-size: 28px;
  font-weight: 600;
  color: #FFFFFF;
  text-shadow:
    1px 1px 2px rgba(0,0,0,0.8),
   -1px -1px 2px rgba(0,0,0,0.8),
    1px -1px 2px rgba(0,0,0,0.8),
   -1px 1px 2px rgba(0,0,0,0.8);
  line-height: 1.3;
  white-space: pre-wrap;
  transition: bottom 0.5s ease; /* smooth animasjon */
}

.subtitle-overlay.subtitle-up {
  bottom: 15%; /* flytter opp n√•r kontroller vises */
}

/* UI container (kontroller) */
#ui {
  position: absolute;
  bottom: 0;
  width: 100%;
  z-index: 10; /* H√∏yere enn underteksten */
}

/* ================= FORBEDRET MOBILVENNLIGHET ================= */

@media (max-width: 768px) {

  body { overflow: hidden; }

  /* Video fyller skjermen korrekt */
  video {
    object-fit: cover;
    height: 100vh;
    width: 100vw;
  }

  /* Mindre toppbar */
  .top-bar {
    padding: 6px 12px;
  }

  .top-bar img {
    width: 34px;
    height: 34px;
  }

  /* Tittel */
  .movie-title {
    font-size: 16px;
    bottom: 70px;
    left: 12px;
  }

  /* Kontroller */
  .controls {
    padding: 8px 10px;
    justify-content: space-between;
  }

  .center-controls .btn img,
  .left-controls .btn img,
  .right-controls .btn img {
    width: 24px;
  }

  /* Like-knapp ‚Äì skjul p√• mobil (for stor) */
  .like-btn {
    font-size: 14px;
    padding: 6px 10px;
  }

  @media (orientation: landscape) {
    .like-btn { display: none; }
  }

  /* Progress bar */
  .progress-container {
    bottom: 58px;
    padding: 0 10px;
  }

  .progress {
    height: 5px;
  }

  .thumb {
    width: 10px;
    height: 10px;
  }

  .time-display {
    font-size: 12px;
    bottom: 70px;
    right: 10px;
  }

  /* Undertekster */
  video::cue,
  .subtitle-overlay {
    font-size: 17px !important;
    bottom: 13% !important;
  }

  .subtitle-overlay.subtitle-up {
    bottom: 22% !important;
  }

  /* Caption-meny */
  .caption-menu {
    right: 10px;
    bottom: 120px;
    min-width: 140px;
  }

  .caption-menu button {
    font-size: 12px;
    padding: 6px 8px;
  }

  /* Fullscreen */
  #fullscreenBtn img {
    width: 28px;
  }

  /* Vannmerke */
  .watermark {
    width: 32px;
    top: 8px;
    right: 8px;
  }
}

/* iPhone SE / veldig sm√• skjermer */
@media (max-width: 420px) {
  .movie-title {
    font-size: 14px;
    bottom: 64px;
  }

  video::cue,
  .subtitle-overlay {
    font-size: 15px !important;
    bottom: 11% !important;
  }

  .subtitle-overlay.subtitle-up {
    bottom: 20% !important;
  }
}

    /* ===================== MOBILSPESIFIKK STYLING ===================== */
@media (max-width: 768px) {

  /* Video fyller skjermen */
  video {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
  }

  /* Toppbar */
  .top-bar {
    padding: 6px 12px;
  }
  .top-bar img {
    width: 34px;
    height: 34px;
  }

  /* Filmtittel */
  .movie-title {
    font-size: 16px;
    bottom: 70px;
    left: 12px;
  }

  /* Kontroller nederst */
  .controls {
    padding: 8px 10px;
    gap: 12px;
  }

  .center-controls .btn img,
  .left-controls .btn img,
  .right-controls .btn img {
    width: 24px;
    height: 24px;
  }

  /* Like-knapp */
  .like-btn {
    font-size: 14px;
    padding: 6px 10px;
  }

  /* Progress bar */
  .progress-container {
    bottom: 58px;
    padding: 0 10px;
  }

  .progress {
    height: 5px;
  }

  .progress-filled {
    height: 100%;
  }

  .thumb {
    width: 10px;
    height: 10px;
  }

  .time-display {
    font-size: 12px;
    bottom: 70px;
    right: 10px;
  }

  /* Undertekster */
  video::cue,
  .subtitle-overlay {
    font-size: 17px !important;
    bottom: 13% !important;
  }

  .subtitle-overlay.subtitle-up {
    bottom: 22% !important;
  }

  /* Caption-meny */
  .caption-menu {
    right: 10px;
    bottom: 120px;
    min-width: 140px;
  }

  .caption-menu button {
    font-size: 12px;
    padding: 6px 8px;
  }

  /* Fullscreen ikon */
  #fullscreenBtn img {
    width: 28px;
  }

  /* Vannmerke */
  .watermark {
    width: 32px;
    top: 8px;
    right: 8px;
  }

  /* Resume-overlay */
  .resume-box {
    padding: 20px;
  }
  .resume-box p {
    font-size: 16px;
  }
  .resume-buttons button {
    font-size: 14px;
    padding: 8px 16px;
  }

  /* Mini-player */
  .miniplayer {
    width: 240px !important;
    height: 135px !important;
    bottom: 16px;
    right: 16px;
  }
}

/* For veldig sm√• skjermer som iPhone SE */
@media (max-width: 420px) {
  .movie-title {
    font-size: 14px;
    bottom: 64px;
  }

 video::cue {
  font-size: 22px; /* valgfritt */
}

.subtitle-overlay {
  font-size: 22px;
  bottom: 13%;
}

  .subtitle-overlay.subtitle-up {
    bottom: 20% !important;
  }

  .progress-container {
    bottom: 50px;
  }

  .time-display {
    font-size: 11px;
    bottom: 62px;
    right: 8px;
  }

  .controls {
    padding: 6px 8px;
  }

  .center-controls .btn img,
  .left-controls .btn img,
  .right-controls .btn img {
    width: 20px;
    height: 20px;
  }

  .like-btn {
    font-size: 12px;
    padding: 4px 8px;
  }
}

    @media (max-width: 768px) {

  .container {
    width: 100vw;
    height: auto;
    aspect-ratio: 16/9; /* Holder proporsjoner */
    position: relative;
    overflow: hidden;
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    position: relative;
  }

  body {
    overflow-y: auto; /* scroll hvis noe er under videoen */
  }
}

/* ===== Undertekster ‚Äì roligere ===== */
.subtitle-overlay {
  font-weight: 400;
  opacity: 0.95;
}







</style>
</head>
<body>
  <div class="container" id="container">
    <video id="video" preload="metadata">
      <source src="" type="video/mp4">
      <track label="Norsk" kind="subtitles" srclang="no" src="" default>
      Din nettleser st√∏tter ikke videoavspilling.
    </video>

    <div class="subtitle-overlay" id="subtitleOverlay"></div>

    <div id="resumeOverlay" class="resume-overlay">
      <div class="resume-box">
        <p>Vil du fortsette der du slapp?</p>
        <div class="resume-buttons">
          <button id="continueBtn">Fortsett</button>
          <button id="restartBtn">Start p√• nytt</button>
        </div>
      </div>
    </div>

    <div class="loading-spinner" id="loadingSpinner"></div>

    <div class="preview-box" id="previewBox">
      <img id="previewImage" src="" alt="Preview">
    </div>

    <div class="ui" id="ui">
      <div class="top-bar">
        <a href="#" class="back-button" id="backButton">
          <img src="https://static.wixstatic.com/media/fd2fb2_59ea5a2a1ff34303a71a369537dd62c3~mv2.png" alt="Back">
        </a>

        <!-- TITTEL FLYTTET HIT -->
        <div class="movie-title">The Curse of the Were-Rabbit</div>
      </div>

      <div class="progress-container">
        <div class="progress" id="progress">
          <div class="progress-filled" id="progressFilled"></div>
          <div class="thumb" id="thumb"></div>
        </div>
      </div>

      <!-- Preview-boksen med bilde + teller -->
      <div class="preview-box" id="previewBox">
        <img id="previewImage" src="" alt="Preview">
        <div class="preview-time" id="previewTime">00:00</div>
      </div>

      <span class="time-display" id="timeDisplay">00:00</span>

      <div class="controls">
        <div class="left-controls">
          <button class="btn like-btn">Kanskje du ogs√• vil like?</button>
        </div>

        <div class="left-controls"></div>

        <div class="center-controls">
          <button class="btn" id="rewindBtn">
            <img src="https://static.wixstatic.com/media/fd2fb2_a6f7229c8e994a75a12d5849e71156a9~mv2.png" alt="Rewind">
          </button>
          <button class="btn" id="playPauseBtn">
            <img id="playIcon" src="https://static.wixstatic.com/media/fd2fb2_f6f25f56b00e49eea8dc4f811b50bb5c~mv2.png" alt="Play/Pause">
          </button>
          <button class="btn" id="forwardBtn">
            <img src="https://static.wixstatic.com/media/fd2fb2_08262621a72944c498e8124d461ce786~mv2.png" alt="Forward">
          </button>
        </div>

        <div class="right-controls">
          <button class="btn" id="muteBtn">
            <img id="muteIcon" src="https://static.wixstatic.com/media/fd2fb2_5c4fab8430e94d2381fc487b1654191d~mv2.png" alt="Mute">
          </button>
          <button class="btn" id="captionsBtn">
            <img src="https://static.wixstatic.com/media/fd2fb2_25072ee44a734507912f0b65f9fc9b0e~mv2.png" alt="Captions">
          </button>
          <button class="btn" id="fullscreenBtn" title="Fullskjerm">
            <img src="https://static.wixstatic.com/media/fd2fb2_3fa37682b3b34c04a2cd08ffcde2763a~mv2.png" alt="Fullscreen">
          </button>
        </div>
      </div>

      <div class="caption-menu" id="captionMenu">
        <strong>Lydspr√•k</strong>
        <div id="audioTracks"></div>
        <strong>Undertekster</strong>
        <div id="subtitleTracks"></div>
      </div>
    </div>
  </div>


<script src="Filmdata.js"></script>
<script src="Seriedata.js"></script>
<script>
/* ===========================================================
   UNIVERSELL PLAYER ‚Äì FILM + SERIE (ALLE FUNKSJONER BEHOLDT)
   =========================================================== */

/* ================= URL PARAMS ================= */
const urlParams = new URLSearchParams(window.location.search);

const navn = urlParams.get("navn") || urlParams.get("id");
const sesong = urlParams.get("sesong") || urlParams.get("s");
const episode = urlParams.get("episode") || urlParams.get("e");

let film;
let filmId = "";
let tilbakeUrl = "";

/* ================= RESOLVE MEDIA ================= */
if (navn && filmer?.[navn] && !sesong && !episode) {
  // ===== FILM =====
  film = filmer[navn];
  filmId = `film-${navn}`;
  tilbakeUrl = film.tilbakeUrl || "filmer.html";

} else if (
  navn &&
  serier?.[navn] &&
  sesong &&
  episode &&
  serier[navn].sesonger?.[sesong]?.episoder?.[episode]
) {
  // ===== SERIE EPISODE =====
  const serie = serier[navn];
  const ep = serie.sesonger[sesong].episoder[episode];

  film = {
    ...ep,
    audioLanguages: serie.audioLanguages || [],
    subtitleLanguages: serie.subtitleLanguages || [],
    tilbakeUrl: `serie.html?navn=${navn}`,
    tittel: `${serie.tittel} ‚Äì S${sesong}E${episode}: ${ep.tittel}`
  };

  filmId = `serie-${navn}-s${sesong}-e${episode}`;

} else {
  alert("Ugyldig innhold");
  window.location.href = "Hovedside.html";
}

/* ================= BASIC SETUP ================= */

// Oppdater dokumenttittel
document.title = film.tittel;

// Oppdater filmtittel i UI
const movieTitleEl = document.querySelector(".movie-title");
if (movieTitleEl && film?.tittel) {
  movieTitleEl.textContent = film.tittel;
}

// Sett tilbakeknapp
const backButton = document.getElementById("backButton");
if (backButton && tilbakeUrl) {
  backButton.addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = tilbakeUrl;
  });
}

// Last video
const video = document.getElementById("video");
video.querySelector("source").src = film.videoUrl;

const track = video.querySelector("track");
if (track && film.subtitleUrl) track.src = film.subtitleUrl;

video.load();

/* ================= DOM ELEMENTS ================= */
const ui = document.getElementById("ui");
const playBtn = document.getElementById("playPauseBtn");
const playIcon = document.getElementById("playIcon");
const muteBtn = document.getElementById("muteBtn");
const muteIcon = document.getElementById("muteIcon");
const rewindBtn = document.getElementById("rewindBtn");
const forwardBtn = document.getElementById("forwardBtn");
const progress = document.getElementById("progress");
const progressFilled = document.getElementById("progressFilled");
const thumb = document.getElementById("thumb");
const timeDisplay = document.getElementById("timeDisplay");
const captionsBtn = document.getElementById("captionsBtn");
const captionMenu = document.getElementById("captionMenu");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const container = document.getElementById("container");
const loadingSpinner = document.getElementById("loadingSpinner");
const previewBox = document.getElementById("previewBox");
const previewImage = document.getElementById("previewImage");
const previewTime = document.getElementById("previewTime");
const subtitleOverlay = document.getElementById("subtitleOverlay");

const resumeOverlay = document.getElementById("resumeOverlay");
const continueBtn = document.getElementById("continueBtn");
const restartBtn = document.getElementById("restartBtn");

/* ================= VARIABLER ================= */
let isDragging = false;
let hideTimeout;
let subtitlesEnabled = true;

// ==================== FUNKSJONER ==================== //
// Format tid til mm:ss
function formatTime(time) {
  const m = Math.floor(time / 60);
  const s = Math.floor(time % 60);
  return `${m}:${s < 10 ? '0' + s : s}`;
}

// Oppdater progress-bar
function updateProgress() {
  if (!isDragging) {
    const percent = (video.currentTime / video.duration) * 100;
    progressFilled.style.width = percent + '%';
    thumb.style.left = percent + '%';
  }
  timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;

  // --- LAGRE PROGRESJON --- //
  if (!isNaN(video.duration) && video.duration > 0) {
    const percent = (video.currentTime / video.duration) * 100;
    localStorage.setItem("progress_" + filmId, percent.toFixed(1));
  }
}

// ==================== EVENTS ==================== //
video.addEventListener('timeupdate', updateProgress);
video.addEventListener('loadedmetadata', updateProgress);

// Play/pause
playBtn.addEventListener('click', () => video.paused ? video.play() : video.pause());
video.addEventListener('click', () => video.paused ? video.play() : video.pause());

document.addEventListener('keydown', e => {
  if (e.code === 'Space') { e.preventDefault(); video.paused ? video.play() : video.pause(); }
  if (e.key === 'ArrowRight') video.currentTime += 10;
  if (e.key === 'ArrowLeft') video.currentTime -= 10;
});

video.addEventListener('play', () => { 
  playIcon.src = "https://static.wixstatic.com/media/fd2fb2_f4658d43d3204506948e5c5ab65461d7~mv2.png"; 
  showUI(); 
});
video.addEventListener('pause', () => { 
  playIcon.src = "https://static.wixstatic.com/media/fd2fb2_f6f25f56b00e49eea8dc4f811b50bb5c~mv2.png"; 
  showUI(); 
});

// Mute
muteBtn.addEventListener('click', () => {
  video.muted = !video.muted;
  muteIcon.src = video.muted
    ? "https://static.wixstatic.com/media/fd2fb2_e7e7e77a59964f018d9e2d4605a047db~mv2.png"
    : "https://static.wixstatic.com/media/fd2fb2_5c4fab8430e94d2381fc487b1654191d~mv2.png";
});

// Rewind/forward
rewindBtn.addEventListener('click', () => video.currentTime = Math.max(0, video.currentTime - 10));
forwardBtn.addEventListener('click', () => video.currentTime = Math.min(video.duration, video.currentTime + 10));

// Captions meny
captionsBtn.addEventListener('click', () => {
  captionMenu.style.display = captionMenu.style.display === 'block' ? 'none' : 'block';
});

// Dynamiske lydknapper
const audioTracksDiv = document.getElementById("audioTracks");
audioTracksDiv.innerHTML = "";
if (film.audioLanguages && film.audioLanguages.length > 0) {
  film.audioLanguages.forEach(lang => {
    const btn = document.createElement("button");
    btn.textContent = lang.label;
    btn.dataset.audio = lang.code;
    btn.addEventListener("click", () => {
      alert(`Lydspr√•k byttet til: ${lang.label}`);
      captionMenu.style.display = "none";
    });
    audioTracksDiv.appendChild(btn);
  });
} else { audioTracksDiv.innerHTML = "<em style='color:gray;'>Ingen valg</em>"; }

// Dynamiske undertekstknapper
const subtitleTracksDiv = document.getElementById("subtitleTracks");
subtitleTracksDiv.innerHTML = "";
if (film.subtitleLanguages && film.subtitleLanguages.length > 0) {
  film.subtitleLanguages.forEach(sub => {
    const btn = document.createElement("button");
    btn.textContent = sub.label;
    btn.dataset.lang = sub.code;
    btn.addEventListener("click", () => {
      const selectedLang = sub.code;
      globalSubtitleSetting = selectedLang;
      localStorage.setItem(subtitleSettingKey, selectedLang);

      if (selectedLang === "off") {
        subtitlesEnabled = false;
        for (let i = 0; i < video.textTracks.length; i++) video.textTracks[i].mode = "hidden";
        subtitleOverlay.textContent = "";
      } else {
        subtitlesEnabled = true;
        for (let i = 0; i < video.textTracks.length; i++) {
          const track = video.textTracks[i];
          if (track.language === selectedLang || track.label.toLowerCase() === selectedLang) {
            track.mode = "hidden"; 
            track.addEventListener("cuechange", () => {
              if (!subtitlesEnabled) {
                subtitleOverlay.textContent = "";
                return;
              }
              const cues = track.activeCues;
              subtitleOverlay.textContent = cues && cues.length > 0 ? cues[0].text : "";
            });
          }
        }
      }
      updateSubtitleButtons(selectedLang);
      captionMenu.style.display = "none";
    });
    subtitleTracksDiv.appendChild(btn);
  });
} else { subtitleTracksDiv.innerHTML = "<em style='color:gray;'>Ingen undertekster</em>"; }

// Scrub-funksjon
function scrubTo(e) {
  const rect = progress.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const percent = Math.min(Math.max(0, x / rect.width), 1);
  progressFilled.style.width = percent * 100 + '%';
  thumb.style.left = percent * 100 + '%';
  return percent;
}

progress.addEventListener('mousedown', e => { isDragging = true; scrubTo(e); });
document.addEventListener('mouseup', e => { 
  if (isDragging) { 
    const percent = scrubTo(e); 
    video.currentTime = percent * video.duration; 
    isDragging = false; 
    hidePreview(); 
  } 
});
document.addEventListener('mousemove', e => { if (isDragging) { scrubTo(e); showPreview(e); } });
thumb.addEventListener('mousedown', e => { e.preventDefault(); isDragging = true; });

// Preview-bilde
const hiddenVideo = document.createElement("video");
hiddenVideo.src = film.videoUrl;
hiddenVideo.muted = true;
hiddenVideo.crossOrigin = "anonymous";
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

function showPreview(e) {
  const rect = progress.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const percent = Math.min(Math.max(0, x / rect.width), 1);
  const time = percent * video.duration;

  previewBox.style.left = `${x - 120}px`;
  previewBox.style.display = "block";
  previewTime.textContent = formatTime(time);

  hiddenVideo.currentTime = time;
  hiddenVideo.addEventListener("seeked", function handler() {
    canvas.width = 240;
    canvas.height = 135;
    ctx.drawImage(hiddenVideo, 0, 0, canvas.width, canvas.height);
    previewImage.src = canvas.toDataURL("image/jpeg");
    hiddenVideo.removeEventListener("seeked", handler);
  });
}
function hidePreview() { previewBox.style.display = "none"; }

progress.addEventListener("mousemove", showPreview);
progress.addEventListener("mouseleave", hidePreview);

// UI vis/skjul
function showUI() {
  ui.classList.remove('hidden');
  subtitleOverlay.classList.add("subtitle-up");
  clearTimeout(hideTimeout);
  hideTimeout = setTimeout(() => {
    if (!video.paused) {
      ui.classList.add('hidden');
      subtitleOverlay.classList.remove("subtitle-up");
    }
  }, 3000);
}
document.addEventListener('mousemove', showUI);
document.addEventListener('keydown', showUI);

// Fullscreen
fullscreenBtn.addEventListener('click', () => {
  if (!document.fullscreenElement) { container.requestFullscreen(); }
  else { document.exitFullscreen(); }
});
document.addEventListener('fullscreenchange', () => {
  fullscreenBtn.querySelector('img').src = document.fullscreenElement
    ? "https://static.wixstatic.com/media/fd2fb2_c9b139f2774c4bf7b32c7271fd6c1c1a~mv2.png"
    : "https://static.wixstatic.com/media/fd2fb2_3fa37682b3b34c04a2cd08ffcde2763a~mv2.png";
});

// Loading spinner
video.addEventListener('waiting', () => loadingSpinner.style.display = 'block');
video.addEventListener('playing', () => loadingSpinner.style.display = 'none');
video.addEventListener('canplay', () => loadingSpinner.style.display = 'none');

// ==================== RESUME ==================== //
const savedTime = parseFloat(localStorage.getItem(`${filmId}-lastPosition`));

video.addEventListener('loadedmetadata', () => {
  if (!isNaN(savedTime) && savedTime > 10 && video.duration > savedTime) {
    video.currentTime = savedTime;
    resumeOverlay.style.display = "flex";

    continueBtn.addEventListener("click", () => {
      resumeOverlay.style.display = "none";
      video.play().catch(err => console.warn("Autoplay blokkert:", err));
    });

    restartBtn.addEventListener("click", () => {
      video.currentTime = 0;
      resumeOverlay.style.display = "none";
      video.play().catch(err => console.warn("Autoplay blokkert:", err));
    });
  } else {
    video.currentTime = 0;
    video.muted = false;
    video.play().catch(err => console.warn("Autoplay blokkert:", err));
  }
});

window.addEventListener('beforeunload', () => {
  localStorage.setItem(`${filmId}-lastPosition`, video.currentTime);
});

// Ferdig
video.addEventListener('ended', () => {
  localStorage.removeItem(`${filmId}-lastPosition`);
  localStorage.removeItem("progress_" + filmId); // fjern fra fortsett √• se
  localStorage.setItem(`${filmId}-status`, "ferdig");
  window.location.href = film.tilbakeUrl;
});

// Skjul mus etter delay
let mouseTimer;
const hideCursorDelay = 3000;
function showCursor() {
  document.body.style.cursor = 'default';
  clearTimeout(mouseTimer);
  mouseTimer = setTimeout(() => { document.body.style.cursor = 'none'; }, hideCursorDelay);
}
document.addEventListener('mousemove', showCursor);
mouseTimer = setTimeout(() => { document.body.style.cursor = 'none'; }, hideCursorDelay);

// Skjul alle spor, vi viser manuelt i overlay
for (let i = 0; i < video.textTracks.length; i++) {
  video.textTracks[i].mode = "hidden";
}

// ==================== GLOBAL SUBTITLE SETTING ==================== //
const subtitleSettingKey = "global-subtitle-setting";
let globalSubtitleSetting = localStorage.getItem(subtitleSettingKey) || "off";

function updateSubtitleButtons(activeLang) {
  document.querySelectorAll("#subtitleTracks button").forEach(btn => {
    if (btn.dataset.lang === activeLang) {
      btn.classList.add("active");
    } else {
      btn.classList.remove("active");
    }
  });
}

video.addEventListener("loadedmetadata", () => {
  if (globalSubtitleSetting === "off") {
    subtitlesEnabled = false;
    for (let i = 0; i < video.textTracks.length; i++) video.textTracks[i].mode = "hidden";
    subtitleOverlay.textContent = "";
  } else {
    subtitlesEnabled = true;
    for (let i = 0; i < video.textTracks.length; i++) {
      const track = video.textTracks[i];
      if (track.language === globalSubtitleSetting || track.label.toLowerCase() === globalSubtitleSetting) {
        track.mode = "hidden";
        track.addEventListener("cuechange", () => {
          if (!subtitlesEnabled) {
            subtitleOverlay.textContent = "";
            return;
          }
          const cues = track.activeCues;
          subtitleOverlay.textContent = cues && cues.length > 0 ? cues[0].text : "";
        });
      }
    }
  }
  updateSubtitleButtons(globalSubtitleSetting);
});

// Hindre h√∏yreklikk p√• videoen
video.addEventListener("contextmenu", (e) => {
  e.preventDefault();
});

// (valgfritt) ‚Äì hindre h√∏yreklikk p√• hele siden
document.addEventListener("contextmenu", (e) => {
  e.preventDefault();
});

</script>


























